<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DOORS Mini (40 комнат)</title>
  <style>
    body {
      margin: 0;
      background: black;
      overflow: hidden;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #game {
      border: 2px solid white;
      background: #111;
      display: block;
      margin: auto;
    }
    #controls {
      margin-top: 10px;
    }
    button {
      font-size: 18px;
      margin: 5px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: #444;
      color: white;
    }
    button:active {
      background: #888;
    }
  </style>
</head>
<body>
  <h2>DOORS Mini (40 комнат)</h2>
  <canvas id="game" width="600" height="400"></canvas>
  <p>Стрелки (ПК) или кнопки (моб). Нажми H / «Шкаф» чтобы спрятаться!</p>

  <div id="controls">
    <button onclick="press('ArrowUp')">▲</button><br>
    <button onclick="press('ArrowLeft')">◀</button>
    <button onclick="press('ArrowDown')">▼</button>
    <button onclick="press('ArrowRight')">▶</button><br>
    <button onclick="toggleCloset()">Шкаф</button>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    let player = { x: 50, y: 180, size: 20, speed: 3, hiding: false };
    let key = { x: 300, y: 100, size: 15, taken: false };
    let door = { x: 550, y: 150, w: 40, h: 100, open: false };
    let closet = { x: 200, y: 150, w: 40, h: 100 };
    let monster = { x: 400, y: 300, size: 25, speed: 1.5, active: false };
    let rush = null; // Rush монстр

    let keys = {};
    let gameOver = false;
    let win = false;
    let room = 1;

    document.addEventListener("keydown", e => {
      keys[e.key] = true;
      if (e.key === "h" || e.key === "H") toggleCloset();
    });
    document.addEventListener("keyup", e => keys[e.key] = false);

    function press(k) {
      keys[k] = true;
      setTimeout(() => keys[k] = false, 150);
    }

    function toggleCloset() {
      // можно спрятаться только если стоишь в шкафу
      if (player.x < closet.x + closet.w &&
          player.x + player.size > closet.x &&
          player.y < closet.y + closet.h &&
          player.y + player.size > closet.y) {
        player.hiding = !player.hiding;
      } else {
        player.hiding = false; // фикс бага
      }
    }

    function drawPlayer() {
      ctx.fillStyle = player.hiding ? "blue" : "cyan";
      ctx.fillRect(player.x, player.y, player.size, player.size);
    }

    function drawKey() {
      if (!key.taken) {
        ctx.fillStyle = "yellow";
        ctx.fillRect(key.x, key.y, key.size, key.size);
      }
    }

    function drawDoor() {
      ctx.fillStyle = door.open ? "green" : "brown";
      ctx.fillRect(door.x, door.y, door.w, door.h);
    }

    function drawCloset() {
      ctx.fillStyle = "gray";
      ctx.fillRect(closet.x, closet.y, closet.w, closet.h);
    }

    function drawMonster() {
      if (monster.active) {
        ctx.fillStyle = "red";
        ctx.fillRect(monster.x, monster.y, monster.size, monster.size);
      }
    }

    function drawRush() {
      if (rush) {
        ctx.fillStyle = "purple";
        ctx.fillRect(rush.x, rush.y, rush.w, rush.h);
      }
    }

    function movePlayer() {
      if (keys["ArrowUp"]) player.y -= player.speed;
      if (keys["ArrowDown"]) player.y += player.speed;
      if (keys["ArrowLeft"]) player.x -= player.speed;
      if (keys["ArrowRight"]) player.x += player.speed;
    }

    function moveMonster() {
      if (!monster.active) return;
      if (player.hiding) return;
      let dx = player.x - monster.x;
      let dy = player.y - monster.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if (dist > 0) {
        monster.x += (dx / dist) * monster.speed;
        monster.y += (dy / dist) * monster.speed;
      }
    }

    function moveRush() {
      if (!rush) return;
      rush.x += rush.speed;
      if (rush.x > canvas.width) rush = null;
    }

    function checkCollisions() {
      // ключ
      if (!key.taken &&
          player.x < key.x + key.size &&
          player.x + player.size > key.x &&
          player.y < key.y + key.size &&
          player.y + player.size > key.y) {
        key.taken = true;
      }

      // дверь
      if (key.taken &&
          player.x < door.x + door.w &&
          player.x + player.size > door.x &&
          player.y < door.y + door.h &&
          player.y + player.size > door.y) {
        door.open = true;
        room++;
        if (room > 40) {
          win = true;
        } else {
          nextRoom();
        }
      }

      // обычный монстр
      if (monster.active && !player.hiding &&
          player.x < monster.x + monster.size &&
          player.x + player.size > monster.x &&
          player.y < monster.y + monster.size &&
          player.y + player.size > monster.y) {
        gameOver = true;
      }

      // Rush монстр
      if (rush && !player.hiding &&
          player.x < rush.x + rush.w &&
          player.x + player.size > rush.x &&
          player.y < rush.y + rush.h &&
          player.y + player.size > rush.y) {
        gameOver = true;
      }
    }

    function nextRoom() {
      player.x = 50; player.y = 180;
      key = { x: 100 + Math.random()*400, y: 50+Math.random()*300, size: 15, taken: false };
      door = { x: 550, y: 150, w: 40, h: 100, open: false };
      closet = { x: 100 + Math.random()*300, y: 150, w: 40, h: 100 };
      monster = { x: 400, y: 300, size: 25, speed: 1.2+room*0.2, active: Math.random()<0.5 };
      rush = null;

      // Rush появляется на 10, 20, 30, 40
      if (room % 10 === 0) {
        monster.active = f
    
